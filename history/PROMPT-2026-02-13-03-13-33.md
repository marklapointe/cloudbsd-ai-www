Make sure to be very granular, like list user roles and permissions in a list in this document, 
so I can append to them here and rerun because this is the design document. If I blow away the code , I want this to be repeatable as possible.

So even when stating that there is a view, describe in this document the size of the view area, objects, and their placement

Security is a priority for me; everything should have SSL/TLS enabled.
If keys aren't present, generate them and store them in `/usr/local/etc/cloudbsd/admin-panel/ssl/`. But we should use a self-signed cert for local development, but check for certbot certificates and to be able to use them. in the json config i should be able to set the servername and port

### Accomplishments & Features

1.  **Project Initialization**: Scaffolded a React + TypeScript project using Vite and Tailwind CSS.
2.  **Backend Implementation**: Created an Express server with SQLite (`better-sqlite3`) for data persistence.
3.  **Authentication & Logging System**:
    - JWT-based authentication.
    - Password hashing using `bcryptjs`.
    - User roles and permissions are stored in SQLite.
    - Historical actions (logins, failures, user management) are logged in a new `logs` table in SQLite.
    - Refactored database logic for better testability and lazy initialization.
    - A default admin account, `admin:admin`, with hashed password, and user roles to go with the user.
    - Admin section implemented to manage users and permissions.
    - Functional user creation with specific roles (Admin, Operator, Viewer).
    - Role-based UI access control. Update this file with the roles and permissions.
4.  **Responsive UI**:
    - Desktop-first design using Tailwind CSS, but make mobile friendly.
    - Responsive sidebar with slide-in animation for mobile devices.
    - Modern, clean dashboard with system health stats.
    - Real-time updates implemented via WebSockets (`socket.io`).
5.  **Infrastructure Management Pages**:
    - Dedicated views for Virtual Machines (bhyve), Docker, FreeBSD Jails, and Podman. Make these components modular, and extensible for future features. So there should be a common core for all of them.
    - Generic `ResourceList` component for consistent UI across different resource types.
6.  **Testing Infrastructure**:
    - Vitest set up for unit testing.
    - React Testing Library for frontend component tests.
    - Verified 100% pass rate for core components and database logic.
7.  **Documentation & History**:
    - Automated versioning for the prompt log.
    - **History Directive**: Every significant update to `PROMPT.md` must be accompanied by a snapshot saved in the `history/` directory.
    - **Filename Pattern**: `PROMPT-P=<YEAR>-<MONTH>-<DAY>-<HOUR>-<MINUTE>-<SECOND>.md`.
8.  **Packaging**:
    - FreeBSD `pkg` port structure created in `pkg/sysutils/cloudbsd-admin`.
    - FreeBSD rc.d script for automatic startup.
9.  **Makefile**:
    - Comprehensive `Makefile` for installation, building, testing, and running.
10. **Demo Mode**:
    - A demo mode is available for testing purposes.
    - The demo mode is enabled by default.
11. **Configuration Management**:
    - Robust configuration system in `server/src/config.ts`.
    - Priority-based loading: Local `etc/config.json` > `/usr/local/etc/cloudbsd/admin-panel/config.json` > Defaults.
    - Supports dynamic port, secret keys, and database paths.
    - Lazy loading and `reloadConfig` support for testing.
12. **Improved Testability**:
    - Decoupled database initialization from module import.
    - Added backend unit tests for configuration and database logic.
13. **Audit Logs & Monitoring**:
    - Dedicated Audit Logs page for admin users to track system-wide actions.
    - Real-time system health metrics (CPU, Memory, Disk) and server info on the Dashboard.
    - Backend API endpoints for system status and historical logs.
14. **Refactored Infrastructure Management**:
    - Unified all infrastructure views (VMs, Docker, Jails, Podman) using a generic `ResourceList` component.
    - Functional resource action buttons (Start, Stop, Restart) with backend integration.
    - Implemented a persistent `resources` table in SQLite to store resource data.
    - Added a "New Resource" modal in the frontend to allow creating new instances (VMs, Containers, Jails).
    - Backend automatically handles resource status changes in demo mode for realistic simulation.
    - Granular role-based access control for actions (Operator/Admin required for management tasks).
    - **Edit Functionality**: Implemented a complete CRUD cycle with a new "Edit Resource" feature, allowing users to modify existing resource configurations.
15. **Security Enhancements**:
    - Implemented SSL/TLS support for the Express server.
    - Automatic self-signed certificate generation if keys are missing.
    - Support for Certbot/Let's Encrypt certificates.
    - Dynamic servername and port configuration.
    - Frontend dynamically adapts to HTTP/HTTPS and WS/WSS based on the environment.
16. **Advanced Monitoring & Configuration**:
    - Enhanced Dashboard with real-time network usage metrics (Inbound/Outbound).
    - **Settings Page**: Created a dedicated settings view for Admin users to inspect system configuration (SSL status, Port, Database path).
    - Improved `PROMPT.md` with granular UI layout descriptions and detailed role-based permission sets.
17. **Console Access**:
    - Implemented a terminal-based console for Docker, Jails, and Podman using `xterm.js`.
    - Integrated WebSockets for real-time terminal data transmission.
    - Added a VNC console placeholder for Virtual Machines (bhyve), prepared for noVNC integration.
    - Proper keyboard input handling and terminal resizing supported.
18. **Backend Connectivity Monitoring**:
    - Automatic health checking of the backend service on startup and periodically (every 10s).
    - Global error notification bar (Red/White) at the top of the UI when backend is unreachable.
    - Automatic recovery detection when backend service returns online.
    - Global axios interceptor to detect and handle network failures immediately.
19. **Licensing & Documentation**:
    - Project licensed under the BSD 3-Clause License.
    - Integrated Swagger/OpenAPI documentation for all backend endpoints.
    - Swagger UI accessible at `/api-docs`.
20. **Database Schema Verification**:
    - Added unit tests to ensure all database fields in `users`, `resources`, `logs`, and `permissions` tables match the technical specifications.
21. **Backend ESM Resolution**:
    - Resolved backend startup issues by correctly configuring `ts-node-dev` for ESM.
    - Switched to `.ts` extensions in imports using `allowImportingTsExtensions` in `tsconfig.json`.
22. **System Information & Containerization**:
    - Implemented database existence check on backend startup with automated directory creation.
    - Enhanced system monitoring using Node's `os` module for real-time host data (CPU model, load, memory, uptime).
    - Added new `/api/system/host` endpoint for detailed server telemetry.
    - Enhanced Dashboard with comprehensive Server Info and Web Frontend Info sections.
    - Provided `Containerfile`s for both backend and frontend services for easy deployment.

### UI Layout & Components

The application follows a **Desktop-First** layout but is fully responsive for mobile devices.

#### 1. Global Layout
- **Sidebar (Left)**: 
    - Fixed at 256px (`w-64`) on desktop. 
    - Collapsible/Slide-in from left on mobile.
    - Background: Slate-900 (`#0f172a`).
    - Top: Brand logo (Blue-500 box with white 'C') and "CloudBSD Admin" title (White, text-xl, bold).
    - Middle: Navigation links with Lucide icons (Dashboard, VMs, Docker, Jails, Podman, Users, Logs, Settings). 
        - Active link: Blue-600 background, White text.
        - Inactive link: Transparent background, Slate-400 text, Slate-800 on hover.
    - Bottom: User profile section (User icon, Username, Role in Slate-500) and Logout button (Red-hover).
- **Backend Status Bar**:
    - Fixed at the very top of the viewport when offline.
    - Background: Red-600 (`#dc2626`).
    - Text: White, bold, centered.
    - Displays: "Backend is offline. Some features may be unavailable. Retrying..."
- **Main Content (Right/Center)**:
    - Fluid width, fills remaining space.
    - Background: Gray-100 (`#f3f4f6`).
    - Padding: 32px (`p-8`).
    - Contains the page title, description, and the main card-based view components.

#### 2. Dashboard View
- **Stats Grid (Top)**: 4 columns on desktop, 1-2 on mobile.
    - Cards for VMs, Docker, Jails, and Podman.
    - Each card: Icon (colored background), Label, and Total Count.
- **Main Section (Middle)**: 2:1 grid layout on desktop.
    - **System Health (Left, 2/3 width)**: 
        - Title and Activity icon.
        - Progress bars for CPU, Memory, and Disk usage (Blue, Emerald, Amber colors).
    - **Server Info (Right, 1/3 width)**: 
        - Title.
        - List items with icons: Hostname (Server icon), CPU (Cpu icon), Uptime (Clock icon), RAM (Total/Free).
        - **Web Frontend Info Section**: Displays browser type, platform, and language.

#### 3. Resource Management Views (VMs, Docker, Jails, Podman)
- **Header**: Flex container with Title/Description on left and "New [Resource]" button on right.
- **Resource Table**: Full-width card with overflow-x: auto.
    - Columns: Name (with icon), Type-specific info (Image, IP, CPU, Memory), Status (Badge), Actions.
    - **Status Badges**:
        - `running`/`up`/`active`: Emerald-50 background, Emerald-700 text.
        - `stopped`/`exited`/`inactive`: Slate-100 background, Slate-700 text.
    - **Actions**: Terminal (Console), Play/Square (Start/Stop), Edit (Pencil), RotateCw (Restart), Trash2 (Delete).

#### 4. Console Modal
- **Size**: Large modal (`max-w-4xl`), fixed height (600px).
- **Header**: Icon (Terminal or Monitor), Resource Name, and Close button.
- **Content Area**: 
    - Black background (`bg-slate-900`).
    - **Containers/Jails**: `xterm.js` terminal filling the entire area.
    - **VMs**: VNC display area (currently a placeholder with a "Connect via VNC" button).
- **Footer**: Status indicator (Connected/Disconnected) and Resource ID.

#### 5. User Management View
- **Header**: Title and Description.
- **Add User Form**: Sidebar-style or top-section form.
    - Fields: Username, Password, Role (Select: Admin, Operator, Viewer).
- **Users Table**: List of all accounts with Role badges and Delete buttons.

#### 6. Audit Logs View
- **Logs Table**: Chronological list of system actions.
    - Columns: Timestamp, User, Action (e.g., LOGIN_SUCCESS, RESOURCE_START), Details.

### User Roles & Permissions

-   **Admin** (`role: 'admin'`)
    -   **Permissions**: `*.*` (Full access).
    -   **User Management**: Can create and delete any user.
    -   **Audit Logs**: Full read access.
    -   **Resources**: Create, Read, Update, Delete (CRUD), and execute actions (Start, Stop, Restart, Console) on all resource types.
    -   **System**: View all system stats and info.

-   **Operator** (`role: 'operator'`)
    -   **Permissions**: `resource.*`, `system.read`.
    -   **User Management**: No access. Sidebar link hidden.
    -   **Audit Logs**: No access. Sidebar link hidden.
    -   **Resources**: CRUD access to resources, and can execute actions (including Console).
    -   **System**: Read-only access to stats and info.

-   **Viewer** (`role: 'viewer'`)
    -   **Permissions**: `*.read`.
    -   **User Management**: No access.
    -   **Audit Logs**: No access.
    -   **Resources**: Read-only access. Actions and "New" buttons are disabled/hidden.
    -   **System**: Read-only access to stats and info.


### Technical Specifications

#### 1. Database Schema (SQLite)

- **Table: `users`**
  - `id`: INTEGER PRIMARY KEY AUTOINCREMENT
  - `username`: TEXT UNIQUE NOT NULL
  - `password`: TEXT NOT NULL (Bcrypt hashed)
  - `role`: TEXT NOT NULL DEFAULT 'viewer' (Enum: 'admin', 'operator', 'viewer')

- **Table: `resources`**
  - `id`: INTEGER PRIMARY KEY AUTOINCREMENT
  - `type`: TEXT NOT NULL (Enum: 'vms', 'docker', 'jails', 'podman')
  - `name`: TEXT NOT NULL
  - `status`: TEXT NOT NULL (e.g., 'running', 'stopped', 'up', 'exited', 'active', 'inactive')
  - `image`: TEXT (Optional)
  - `ip`: TEXT (Optional)
  - `cpu`: INTEGER (Optional)
  - `memory`: TEXT (Optional)
  - `created_at`: DATETIME DEFAULT CURRENT_TIMESTAMP

- **Table: `logs`**
  - `id`: INTEGER PRIMARY KEY AUTOINCREMENT
  - `timestamp`: DATETIME DEFAULT CURRENT_TIMESTAMP
  - `user_id`: INTEGER (Foreign Key to `users.id`, SET NULL on delete)
  - `action`: TEXT NOT NULL
  - `details`: TEXT

#### 2. API Endpoints

The backend provides a RESTful API, fully documented via Swagger at `/api-docs`.

- **Auth**:
  - `GET /api/health`: Public endpoint to check backend status.
  - `POST /api/login`: Authenticate and receive JWT.

- **Users (Admin Only)**:
  - `GET /api/users`: List all users.
  - `POST /api/users`: Create new user.
  - `DELETE /api/users/:id`: Delete a user.

- **Logs (Admin Only)**:
  - `GET /api/logs`: Fetch recent system audit logs.

- **Resources (Authenticated)**:
  - `GET /api/:resource`: List resources of type (vms, docker, jails, podman).
  - `POST /api/:resource`: Create new resource (Operator/Admin).
  - `PUT /api/:resource/:id`: Update existing resource (Operator/Admin).
  - `DELETE /api/:resource/:id`: Remove resource (Operator/Admin).
  - `POST /api/:resource/:id/:action`: Execute action (start, stop, restart) (Operator/Admin).

- **System**:
  - `GET /api/system/stats`: Real-time health metrics.
  - `GET /api/system/info`: Server hardware/OS details.
  - `GET /api/system/config`: System configuration (Admin Only).
  - `GET /api/system/host`: Detailed host telemetry (OS, CPU, Memory).

### Rationale

-   **Next.js/React + Vite**: Chosen for fast development cycle and modern ecosystem. Vite provides superior performance compared to traditional CRA.
-   **SQLite**: Ideal for local infrastructure management as it requires zero configuration and is highly reliable for single-node admin panels.
-   **Tailwind CSS**: Enables rapid UI development with a mobile-first approach, ensuring the management panel is usable on the go.
-   **Generic Components**: Reducing code duplication for similar list views (Docker/Podman/Jails) makes the codebase easier to maintain.
-   **History Directory**: Ensuring reproducibility and tracking of development milestones.
-   **Configuration Layer**: Using a dedicated config module allows for environment-specific settings without changing code, crucial for FreeBSD deployment patterns.
-   **Action Logging**: Essential for auditing who performed what action on the infrastructure, even in a single-admin scenario.
-   **Connectivity Monitoring**: Critical for user experience in distributed environments (Web UI vs Backend), ensuring the user is aware of the system state immediately upon failure.
-   **OpenAPI/Swagger**: Provides clear, interactive documentation for the backend API, facilitating integration and testing.
-   **BSD 3-Clause License**: A permissive license that encourages open-source contribution while protecting the author's name.
